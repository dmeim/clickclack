# TypeSetGo Migration Plan
## From: Next.js + Node.js + Socket.io + Supabase
## To: Bun + Vite + Convex + Shadcn/UI

---

## ğŸ“‹ Executive Summary

This document outlines the migration of TypeSetGo from a Next.js monolith with custom Socket.io server to a modern, decoupled architecture using Bun, Vite, and Convex.

### Current Stack
| Layer | Technology |
|-------|------------|
| Runtime | Node.js |
| Framework | Next.js 16 (App Router) |
| React | React 19 |
| Real-time | Socket.io (custom server.js) |
| Database | Supabase (minimal usage) |
| Styling | Tailwind CSS v4 |
| Routing | Next.js file-based |

### Target Stack
| Layer | Technology |
|-------|------------|
| Runtime | Bun |
| Frontend | Vite + React 19 + TypeScript |
| Backend/DB | Convex (real-time database + backend functions) |
| Styling | Tailwind CSS + Shadcn/UI |
| State | Convex Hooks (useQuery, useMutation) + React local state |
| Forms | react-hook-form + zod |
| Routing | react-router-dom v6+ |
| Testing | Vitest (unit) + Playwright (E2E) |
| Containers | Docker + Docker Compose |
| Deployment | Self-hosted VPS (Docker) + Convex Cloud |
| Reverse Proxy | Nginx |

---

## ğŸ¯ Migration Phases

### Phase 0: Preparation (Day 1)
- [ ] Create new branch: `git checkout -b migration/bun-vite-convex`
- [ ] Document current feature parity checklist
- [ ] Set up Convex account and project
- [ ] Ensure all current features work (manual smoke test)

---

## Phase 1: Project Scaffolding
**Estimated Time: 2-3 hours**

### 1.1 Initialize New Vite Project with Bun

```bash
# Create new project directory (we'll merge later)
cd ..
bun create vite typesetgo-new --template react-ts
cd typesetgo-new

# Install core dependencies
bun add react-router-dom@6 @tanstack/react-query convex
bun add react-hook-form zod @hookform/resolvers
bun add -d tailwindcss postcss autoprefixer
bun add -d vitest @testing-library/react playwright
```

### 1.2 Project Structure

```
typesetgo-new/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ sounds/          # Copy from current
â”‚   â”œâ”€â”€ themes/          # Copy from current
â”‚   â”œâ”€â”€ words/           # Copy from current
â”‚   â””â”€â”€ quotes/          # Copy from current
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/          # Shadcn components
â”‚   â”‚   â”œâ”€â”€ typing/      # TypingPractice, etc.
â”‚   â”‚   â”œâ”€â”€ connect/     # Host/Join cards
â”‚   â”‚   â”œâ”€â”€ plan/        # Plan mode components
â”‚   â”‚   â””â”€â”€ settings/    # Sound, Ghost, Theme modals
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useTypingSession.ts
â”‚   â”‚   â”œâ”€â”€ useSound.ts
â”‚   â”‚   â””â”€â”€ useLocalStorage.ts
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ colors.ts
â”‚   â”‚   â”œâ”€â”€ sounds.ts
â”‚   â”‚   â”œâ”€â”€ storage-utils.ts
â”‚   â”‚   â””â”€â”€ typing-constants.ts
â”‚   â”œâ”€â”€ pages/           # or routes/
â”‚   â”‚   â”œâ”€â”€ Home.tsx
â”‚   â”‚   â”œâ”€â”€ Connect.tsx
â”‚   â”‚   â”œâ”€â”€ Host.tsx
â”‚   â”‚   â””â”€â”€ Join.tsx
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ plan.ts
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ main.tsx
â”‚   â””â”€â”€ index.css
â”œâ”€â”€ convex/
â”‚   â”œâ”€â”€ schema.ts        # Database schema
â”‚   â”œâ”€â”€ rooms.ts         # Room mutations/queries
â”‚   â”œâ”€â”€ users.ts         # User management
â”‚   â””â”€â”€ _generated/      # Auto-generated by Convex
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â””â”€â”€ e2e/
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ nginx.conf
â”œâ”€â”€ index.html
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ package.json
```

### 1.3 Vite Configuration

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 3000,
  },
  build: {
    outDir: 'dist',
    sourcemap: true,
  },
})
```

### 1.4 Tasks
- [ ] Run `bun create vite` with React + TypeScript template
- [ ] Configure path aliases (`@/`)
- [ ] Set up Tailwind CSS
- [ ] Install Shadcn/UI CLI and init
- [ ] Copy static assets (sounds, themes, words, quotes)
- [ ] Copy `lib/` utilities (colors, sounds, storage-utils, typing-constants)
- [ ] Copy `types/` definitions

---

## Phase 2: Tailwind CSS + Shadcn/UI Setup
**Estimated Time: 1-2 hours**

### 2.1 Tailwind Installation

```bash
bunx tailwindcss init -p
```

```typescript
// tailwind.config.ts
import type { Config } from 'tailwindcss'

export default {
  darkMode: ['class'],
  content: [
    './index.html',
    './src/**/*.{js,ts,jsx,tsx}',
  ],
  theme: {
    extend: {
      fontFamily: {
        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-out',
        'pulse': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0', transform: 'translateY(10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
      },
    },
  },
  plugins: [],
} satisfies Config
```

### 2.2 Shadcn/UI Setup

```bash
bunx shadcn@latest init
```

Install commonly needed components:
```bash
bunx shadcn@latest add button dialog dropdown-menu input label select slider switch tabs toast
```

### 2.3 Tasks
- [ ] Configure Tailwind with custom theme (migrate from current globals.css)
- [ ] Initialize Shadcn/UI
- [ ] Install base components (Button, Dialog, Input, Select, Slider, Switch, Tabs, Toast)
- [ ] Create custom theme variables in CSS
- [ ] Migrate `GLOBAL_COLORS` to CSS variables + Tailwind config

---

## Phase 3: Routing Setup
**Estimated Time: 1-2 hours**

### 3.1 React Router Configuration

```typescript
// src/main.tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import { ConvexProvider, ConvexReactClient } from 'convex/react'
import App from './App'
import './index.css'

const convex = new ConvexReactClient(import.meta.env.VITE_CONVEX_URL)

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ConvexProvider client={convex}>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </ConvexProvider>
  </React.StrictMode>,
)
```

```typescript
// src/App.tsx
import { Routes, Route } from 'react-router-dom'
import Home from './pages/Home'
import Connect from './pages/Connect'
import Host from './pages/Host'
import Join from './pages/Join'

export default function App() {
  return (
    <Routes>
      <Route path="/" element={<Home />} />
      <Route path="/connect" element={<Connect />} />
      <Route path="/connect/host" element={<Host />} />
      <Route path="/connect/join" element={<Join />} />
    </Routes>
  )
}
```

### 3.2 Migration Mapping

| Next.js Route | React Router Route |
|---------------|-------------------|
| `app/page.tsx` | `pages/Home.tsx` |
| `app/connect/page.tsx` | `pages/Connect.tsx` |
| `app/connect/host/page.tsx` | `pages/Host.tsx` |
| `app/connect/join/page.tsx` | `pages/Join.tsx` |

### 3.3 Tasks
- [ ] Set up React Router with routes matching current pages
- [ ] Replace all `next/link` `<Link>` with `react-router-dom` `<Link>`
- [ ] Replace `useSearchParams` from next/navigation with react-router's
- [ ] Remove all `"use client"` directives (not needed in Vite)

---

## Phase 4: Convex Setup & Schema Design
**Estimated Time: 3-4 hours**

### 4.1 Convex Initialization

```bash
bunx convex dev
```

### 4.2 Database Schema

```typescript
// convex/schema.ts
import { defineSchema, defineTable } from 'convex/server'
import { v } from 'convex/values'

export default defineSchema({
  // Rooms for multiplayer Connect mode
  rooms: defineTable({
    code: v.string(),              // 5-char room code (e.g., "ABC12")
    hostId: v.string(),            // Convex identity or session ID
    hostName: v.string(),
    status: v.union(v.literal('waiting'), v.literal('active')),
    settings: v.object({
      mode: v.string(),
      duration: v.number(),
      wordTarget: v.number(),
      difficulty: v.string(),
      punctuation: v.boolean(),
      numbers: v.boolean(),
      quoteLength: v.string(),
      presetText: v.optional(v.string()),
      presetModeType: v.optional(v.string()),
      ghostWriterEnabled: v.boolean(),
      ghostWriterSpeed: v.number(),
      soundEnabled: v.boolean(),
      typingFontSize: v.number(),
      textAlign: v.string(),
      theme: v.optional(v.any()),  // Theme object
      plan: v.optional(v.any()),   // Plan array
      planIndex: v.optional(v.number()),
    }),
    createdAt: v.number(),
    expiresAt: v.number(),         // Auto-cleanup after inactivity
  })
    .index('by_code', ['code'])
    .index('by_host', ['hostId']),

  // Participants in rooms
  participants: defineTable({
    roomId: v.id('rooms'),
    sessionId: v.string(),         // Browser session ID
    name: v.string(),
    isConnected: v.boolean(),
    stats: v.object({
      wpm: v.number(),
      accuracy: v.number(),
      progress: v.number(),
      wordsTyped: v.number(),
      timeElapsed: v.number(),
      isFinished: v.boolean(),
    }),
    typedText: v.optional(v.string()),
    targetText: v.optional(v.string()),
    joinedAt: v.number(),
    lastSeen: v.number(),
  })
    .index('by_room', ['roomId'])
    .index('by_session', ['sessionId']),

  // Future: User accounts (for when you add Clerk)
  users: defineTable({
    clerkId: v.optional(v.string()),
    email: v.optional(v.string()),
    name: v.string(),
    createdAt: v.number(),
    // Stats aggregation
    totalTests: v.number(),
    averageWpm: v.number(),
    averageAccuracy: v.number(),
    bestWpm: v.number(),
  })
    .index('by_clerk', ['clerkId']),

  // Future: Test history
  testResults: defineTable({
    userId: v.optional(v.id('users')),
    sessionId: v.optional(v.string()),  // For anonymous users
    mode: v.string(),
    wpm: v.number(),
    accuracy: v.number(),
    rawWpm: v.number(),
    duration: v.number(),
    wordCount: v.number(),
    metadata: v.optional(v.any()),
    createdAt: v.number(),
  })
    .index('by_user', ['userId'])
    .index('by_session', ['sessionId']),
})
```

### 4.3 Room Management Functions

```typescript
// convex/rooms.ts
import { mutation, query } from './_generated/server'
import { v } from 'convex/values'

// Generate 5-character room code
function generateRoomCode(): string {
  return Math.random().toString(36).substring(2, 7).toUpperCase()
}

export const create = mutation({
  args: {
    hostName: v.string(),
    hostSessionId: v.string(),
  },
  handler: async (ctx, args) => {
    const code = generateRoomCode()
    const now = Date.now()
    
    const roomId = await ctx.db.insert('rooms', {
      code,
      hostId: args.hostSessionId,
      hostName: args.hostName,
      status: 'waiting',
      settings: {
        mode: 'time',
        duration: 30,
        wordTarget: 25,
        difficulty: 'medium',
        punctuation: false,
        numbers: false,
        quoteLength: 'all',
        ghostWriterEnabled: false,
        ghostWriterSpeed: 60,
        soundEnabled: false,
        typingFontSize: 3.5,
        textAlign: 'left',
      },
      createdAt: now,
      expiresAt: now + 15 * 60 * 1000, // 15 min expiry
    })
    
    return { roomId, code }
  },
})

export const getByCode = query({
  args: { code: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db
      .query('rooms')
      .withIndex('by_code', (q) => q.eq('code', args.code))
      .first()
  },
})

export const updateSettings = mutation({
  args: {
    roomId: v.id('rooms'),
    settings: v.any(),
  },
  handler: async (ctx, args) => {
    const room = await ctx.db.get(args.roomId)
    if (!room) throw new Error('Room not found')
    
    await ctx.db.patch(args.roomId, {
      settings: { ...room.settings, ...args.settings },
    })
  },
})

export const setStatus = mutation({
  args: {
    roomId: v.id('rooms'),
    status: v.union(v.literal('waiting'), v.literal('active')),
  },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.roomId, { status: args.status })
  },
})

export const claimHost = mutation({
  args: {
    code: v.string(),
    sessionId: v.string(),
  },
  handler: async (ctx, args) => {
    const room = await ctx.db
      .query('rooms')
      .withIndex('by_code', (q) => q.eq('code', args.code))
      .first()
    
    if (!room) return { success: false, error: 'Room not found' }
    
    await ctx.db.patch(room._id, { hostId: args.sessionId })
    
    const participants = await ctx.db
      .query('participants')
      .withIndex('by_room', (q) => q.eq('roomId', room._id))
      .collect()
    
    return {
      success: true,
      room,
      participants,
    }
  },
})
```

### 4.4 Participant Functions

```typescript
// convex/participants.ts
import { mutation, query } from './_generated/server'
import { v } from 'convex/values'

export const join = mutation({
  args: {
    roomCode: v.string(),
    sessionId: v.string(),
    name: v.string(),
  },
  handler: async (ctx, args) => {
    const room = await ctx.db
      .query('rooms')
      .withIndex('by_code', (q) => q.eq('code', args.roomCode))
      .first()
    
    if (!room) throw new Error('Room not found')
    
    // Check for existing participant with same session (reconnect)
    const existing = await ctx.db
      .query('participants')
      .withIndex('by_session', (q) => q.eq('sessionId', args.sessionId))
      .first()
    
    if (existing && existing.roomId === room._id) {
      // Reconnecting
      await ctx.db.patch(existing._id, {
        isConnected: true,
        lastSeen: Date.now(),
      })
      return { participantId: existing._id, isReconnect: true, room }
    }
    
    const now = Date.now()
    const participantId = await ctx.db.insert('participants', {
      roomId: room._id,
      sessionId: args.sessionId,
      name: args.name,
      isConnected: true,
      stats: {
        wpm: 0,
        accuracy: 0,
        progress: 0,
        wordsTyped: 0,
        timeElapsed: 0,
        isFinished: false,
      },
      joinedAt: now,
      lastSeen: now,
    })
    
    return { participantId, isReconnect: false, room }
  },
})

export const updateStats = mutation({
  args: {
    participantId: v.id('participants'),
    stats: v.object({
      wpm: v.number(),
      accuracy: v.number(),
      progress: v.number(),
      wordsTyped: v.number(),
      timeElapsed: v.number(),
      isFinished: v.boolean(),
    }),
    typedText: v.optional(v.string()),
    targetText: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.participantId, {
      stats: args.stats,
      typedText: args.typedText,
      targetText: args.targetText,
      lastSeen: Date.now(),
    })
  },
})

export const listByRoom = query({
  args: { roomId: v.id('rooms') },
  handler: async (ctx, args) => {
    return await ctx.db
      .query('participants')
      .withIndex('by_room', (q) => q.eq('roomId', args.roomId))
      .collect()
  },
})

export const kick = mutation({
  args: { participantId: v.id('participants') },
  handler: async (ctx, args) => {
    await ctx.db.delete(args.participantId)
  },
})

export const resetStats = mutation({
  args: { participantId: v.id('participants') },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.participantId, {
      stats: {
        wpm: 0,
        accuracy: 0,
        progress: 0,
        wordsTyped: 0,
        timeElapsed: 0,
        isFinished: false,
      },
      typedText: undefined,
      targetText: undefined,
    })
  },
})
```

### 4.5 Tasks
- [ ] Run `bunx convex dev` to initialize Convex
- [ ] Create schema.ts with rooms, participants, users, testResults tables
- [ ] Create rooms.ts with CRUD operations
- [ ] Create participants.ts with join/stats/kick operations
- [ ] Test real-time subscriptions locally

---

## Phase 5: Component Migration
**Estimated Time: 4-6 hours**

### 5.1 Changes Required for Each Component

| Component | Changes Needed |
|-----------|----------------|
| `TypingPractice.tsx` | Remove `"use client"`, replace `next/link` with `react-router-dom`, convert API calls to static imports or Convex |
| `HostCard.tsx` | Remove Next.js imports, use React Router navigation |
| `JoinCard.tsx` | Same as above |
| `UserHostCard.tsx` | Minimal changes (mostly React) |
| `SoundController.tsx` | Convert API call to static manifest |
| `GhostWriterController.tsx` | Pure React, minimal changes |
| `ColorPicker.tsx` | Pure React, minimal changes |
| `Plan components` | Pure React, minimal changes |

### 5.2 API Route Migration

**Current API Routes â†’ New Approach**

| Current | New Approach |
|---------|--------------|
| `/api/sounds` | Vite static import OR build-time manifest generation |
| `/api/themes` | Vite static import OR build-time manifest generation |

```typescript
// Option 1: Static import (simpler)
// src/lib/sounds-manifest.ts
export const soundManifest = {
  typing: {
    bubbles: ['bubbles_01.wav', 'bubbles_02.wav', 'bubbles_03.wav'],
    creamy: ['creamy_01.wav', /* ... */],
    // ... rest
  },
  warning: {
    clock: ['clock.wav'],
  },
}

// Option 2: Build-time generation via Vite plugin
// vite.config.ts - custom plugin to generate manifest at build time
```

### 5.3 Socket.io â†’ Convex Migration

| Socket.io Event | Convex Equivalent |
|-----------------|-------------------|
| `create_room` | `useMutation(api.rooms.create)` |
| `claim_host` | `useMutation(api.rooms.claimHost)` |
| `join_room` | `useMutation(api.participants.join)` |
| `update_settings` | `useMutation(api.rooms.updateSettings)` |
| `start_test` | `useMutation(api.rooms.setStatus)` |
| `stop_test` | `useMutation(api.rooms.setStatus)` |
| `reset_test` | `useMutation(api.rooms.resetAll)` |
| `send_stats` | `useMutation(api.participants.updateStats)` |
| `kick_user` | `useMutation(api.participants.kick)` |
| `user_joined` event | `useQuery(api.participants.listByRoom)` (reactive) |
| `stats_update` event | `useQuery(api.participants.listByRoom)` (reactive) |

### 5.4 Example: Host Component with Convex

```typescript
// src/pages/Host.tsx
import { useQuery, useMutation } from 'convex/react'
import { api } from '../../convex/_generated/api'
import { useEffect, useState } from 'react'
import { useSearchParams } from 'react-router-dom'

export default function Host() {
  const [searchParams] = useSearchParams()
  const hostName = searchParams.get('name') || 'Host'
  
  const [roomCode, setRoomCode] = useState<string | null>(null)
  const [sessionId] = useState(() => crypto.randomUUID())
  
  const createRoom = useMutation(api.rooms.create)
  const updateSettings = useMutation(api.rooms.updateSettings)
  const setStatus = useMutation(api.rooms.setStatus)
  
  // Get room data reactively
  const room = useQuery(
    api.rooms.getByCode, 
    roomCode ? { code: roomCode } : 'skip'
  )
  
  // Get participants reactively (auto-updates when anyone joins/leaves/updates stats!)
  const participants = useQuery(
    api.participants.listByRoom,
    room ? { roomId: room._id } : 'skip'
  )
  
  useEffect(() => {
    const initRoom = async () => {
      const result = await createRoom({ 
        hostName, 
        hostSessionId: sessionId 
      })
      setRoomCode(result.code)
    }
    initRoom()
  }, [])
  
  const handleStartTest = () => {
    if (room) {
      setStatus({ roomId: room._id, status: 'active' })
    }
  }
  
  // ... rest of component
  // participants auto-updates in real-time via Convex subscription!
}
```

### 5.5 Tasks
- [ ] Create static sound manifest (eliminate /api/sounds)
- [ ] Create static theme manifest (eliminate /api/themes)
- [ ] Migrate TypingPractice.tsx (largest component)
- [ ] Migrate Connect page components
- [ ] Migrate Host page with Convex hooks
- [ ] Migrate Join page with Convex hooks
- [ ] Migrate all modal components
- [ ] Migrate utility components (ColorPicker, SoundController, etc.)

---

## Phase 6: Form Handling with react-hook-form + Zod
**Estimated Time: 1-2 hours**

### 6.1 Form Schemas

```typescript
// src/lib/schemas.ts
import { z } from 'zod'

export const joinRoomSchema = z.object({
  name: z.string().min(1, 'Name is required').max(20, 'Name too long'),
  code: z.string().length(5, 'Code must be 5 characters').toUpperCase(),
})

export const hostRoomSchema = z.object({
  name: z.string().min(1, 'Name is required').max(20, 'Name too long'),
})

export const presetTextSchema = z.object({
  text: z.string()
    .min(1, 'Text is required')
    .max(10000, 'Text exceeds 10,000 characters'),
})

export type JoinRoomInput = z.infer<typeof joinRoomSchema>
export type HostRoomInput = z.infer<typeof hostRoomSchema>
export type PresetTextInput = z.infer<typeof presetTextSchema>
```

### 6.2 Example Form Component

```typescript
// src/components/connect/JoinCard.tsx
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { joinRoomSchema, type JoinRoomInput } from '@/lib/schemas'
import { useNavigate } from 'react-router-dom'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'

export function JoinCard() {
  const navigate = useNavigate()
  
  const form = useForm<JoinRoomInput>({
    resolver: zodResolver(joinRoomSchema),
    defaultValues: {
      name: '',
      code: '',
    },
  })
  
  const onSubmit = (data: JoinRoomInput) => {
    navigate(`/connect/join?name=${data.name}&code=${data.code}`)
  }
  
  return (
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
      <div>
        <Label htmlFor="name">Your Name</Label>
        <Input
          id="name"
          {...form.register('name')}
          placeholder="Enter your name"
        />
        {form.formState.errors.name && (
          <p className="text-red-500 text-sm mt-1">
            {form.formState.errors.name.message}
          </p>
        )}
      </div>
      
      <div>
        <Label htmlFor="code">Room Code</Label>
        <Input
          id="code"
          {...form.register('code')}
          placeholder="XXXXX"
          className="uppercase tracking-widest text-center font-mono"
        />
        {form.formState.errors.code && (
          <p className="text-red-500 text-sm mt-1">
            {form.formState.errors.code.message}
          </p>
        )}
      </div>
      
      <Button type="submit" className="w-full">
        Join Room
      </Button>
    </form>
  )
}
```

### 6.3 Tasks
- [ ] Create Zod schemas for all forms
- [ ] Refactor JoinCard with react-hook-form
- [ ] Refactor HostCard with react-hook-form
- [ ] Refactor preset text input modal
- [ ] Refactor settings modals

---

## Phase 7: Testing Setup
**Estimated Time: 2-3 hours**

### 7.1 Vitest Configuration

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./tests/setup.ts'],
    include: ['./tests/unit/**/*.test.{ts,tsx}'],
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
```

```typescript
// tests/setup.ts
import '@testing-library/jest-dom'
```

### 7.2 Sample Unit Tests

```typescript
// tests/unit/typing.test.ts
import { describe, it, expect } from 'vitest'
import { computeStats } from '@/lib/typing-utils'

describe('computeStats', () => {
  it('calculates correct characters', () => {
    const stats = computeStats('hello', 'hello')
    expect(stats.correct).toBe(5)
    expect(stats.incorrect).toBe(0)
  })

  it('calculates incorrect characters', () => {
    const stats = computeStats('hallo', 'hello')
    expect(stats.correct).toBe(4)
    expect(stats.incorrect).toBe(1)
  })
})
```

### 7.3 Playwright E2E Tests

```typescript
// tests/e2e/typing.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Typing Practice', () => {
  test('should start typing test when user types', async ({ page }) => {
    await page.goto('/')
    
    // Focus the input
    await page.click('[data-testid="typing-area"]')
    
    // Type some text
    await page.keyboard.type('hello')
    
    // Check that stats are updating
    await expect(page.locator('[data-testid="wpm-display"]')).toBeVisible()
  })

  test('should navigate to connect page', async ({ page }) => {
    await page.goto('/')
    await page.click('a[href="/connect"]')
    await expect(page).toHaveURL('/connect')
  })
})
```

### 7.4 Tasks
- [ ] Configure Vitest
- [ ] Set up testing utilities
- [ ] Write unit tests for typing logic (computeStats, generateWords)
- [ ] Write unit tests for utility functions
- [ ] Configure Playwright
- [ ] Write E2E tests for core flows (typing, connect, host, join)

---

## Phase 8: Docker & Deployment Configuration
**Estimated Time: 2-3 hours**

### 8.1 Dockerfile

```dockerfile
# docker/Dockerfile
FROM oven/bun:1 AS builder

WORKDIR /app

# Copy package files
COPY package.json bun.lockb ./

# Install dependencies
RUN bun install --frozen-lockfile

# Copy source
COPY . .

# Build
RUN bun run build

# Production image
FROM nginx:alpine

# Copy built assets
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy nginx config
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 8.2 Docker Compose

```yaml
# docker/docker-compose.yml
version: '3.8'

services:
  typesetgo:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "3000:80"
    environment:
      - VITE_CONVEX_URL=${CONVEX_URL}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.typesetgo.rule=Host(`typesetgo.yourdomain.com`)"

  # Optional: Traefik for reverse proxy (alternative to nginx)
  # traefik:
  #   image: traefik:v2.10
  #   ...
```

### 8.3 Nginx Configuration

```nginx
# docker/nginx.conf
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Cache static assets
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA routing - serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

### 8.4 Production Nginx with SSL

```nginx
# /etc/nginx/sites-available/typesetgo
server {
    listen 80;
    server_name typesetgo.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name typesetgo.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/typesetgo.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/typesetgo.yourdomain.com/privkey.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 8.5 Tasks
- [ ] Create Dockerfile with Bun builder stage
- [ ] Create docker-compose.yml
- [ ] Create nginx.conf for SPA routing
- [ ] Test local Docker build
- [ ] Create production nginx config with SSL
- [ ] Document deployment steps

---

## Phase 9: Final Migration & Cleanup
**Estimated Time: 2-3 hours**

### 9.1 File Cleanup Checklist

**Files to DELETE from original project:**
- [ ] `app/` directory (all Next.js pages)
- [ ] `server.js` (Socket.io server)
- [ ] `next.config.mjs`
- [ ] `next-env.d.ts`
- [ ] `postcss.config.mjs` (if replaced)
- [ ] Old Dockerfile

**Files to KEEP and merge:**
- [ ] `public/sounds/` â†’ copy to new project
- [ ] `public/themes/` â†’ copy to new project
- [ ] `public/words/` â†’ copy to new project
- [ ] `public/quotes/` â†’ copy to new project
- [ ] `public/assets/` â†’ copy to new project
- [ ] `lib/*.ts` â†’ copy to `src/lib/`
- [ ] `types/*.ts` â†’ copy to `src/types/`
- [ ] `docs/` â†’ keep as documentation

### 9.2 Package.json Updates

```json
{
  "name": "typesetgo",
  "version": "0.2.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext ts,tsx",
    "test": "vitest",
    "test:e2e": "playwright test",
    "convex:dev": "convex dev",
    "convex:deploy": "convex deploy"
  },
  "dependencies": {
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-router-dom": "^6.x",
    "convex": "^1.x",
    "react-hook-form": "^7.x",
    "@hookform/resolvers": "^3.x",
    "zod": "^3.x",
    "@dnd-kit/core": "^6.x",
    "@dnd-kit/sortable": "^10.x",
    "class-variance-authority": "^0.7.x",
    "clsx": "^2.x",
    "tailwind-merge": "^2.x"
  },
  "devDependencies": {
    "@types/react": "^19.x",
    "@types/react-dom": "^19.x",
    "@vitejs/plugin-react": "^4.x",
    "autoprefixer": "^10.x",
    "postcss": "^8.x",
    "tailwindcss": "^4.x",
    "typescript": "^5.x",
    "vite": "^6.x",
    "vitest": "^2.x",
    "@testing-library/react": "^16.x",
    "@playwright/test": "^1.x",
    "eslint": "^9.x"
  }
}
```

### 9.3 Environment Variables

```bash
# .env.local (development)
VITE_CONVEX_URL=https://your-project.convex.cloud

# Future: When adding Clerk
# VITE_CLERK_PUBLISHABLE_KEY=pk_test_...
```

### 9.4 Tasks
- [ ] Merge new project into original repo
- [ ] Delete old Next.js files
- [ ] Update package.json scripts
- [ ] Update README.md with new setup instructions
- [ ] Update AGENTS.md with new conventions
- [ ] Run full test suite
- [ ] Manual smoke test all features
- [ ] Deploy to staging environment
- [ ] Deploy Convex to production

---

## ğŸ“Š Migration Checklist Summary

### Core Features Parity
- [ ] Typing practice (time, words, quote, zen, preset modes)
- [ ] Ghost writer functionality
- [ ] Sound effects
- [ ] Theme customization
- [ ] Settings persistence (localStorage)
- [ ] Plan mode
- [ ] Connect/Multiplayer: Host room
- [ ] Connect/Multiplayer: Join room
- [ ] Connect/Multiplayer: Real-time stats sync
- [ ] Connect/Multiplayer: Host controls (kick, reset, start/stop)
- [ ] Mobile responsiveness

### New Improvements
- [ ] Faster dev server (Vite HMR)
- [ ] Smaller bundle size
- [ ] Better form validation (react-hook-form + zod)
- [ ] Polished UI (Shadcn components)
- [ ] Real-time without custom server (Convex)
- [ ] Unit test coverage
- [ ] E2E test coverage
- [ ] Docker deployment ready

---

## â±ï¸ Estimated Total Time

| Phase | Time |
|-------|------|
| Phase 0: Preparation | 1-2 hours |
| Phase 1: Project Scaffolding | 2-3 hours |
| Phase 2: Tailwind + Shadcn | 1-2 hours |
| Phase 3: Routing | 1-2 hours |
| Phase 4: Convex Setup | 3-4 hours |
| Phase 5: Component Migration | 4-6 hours |
| Phase 6: Form Handling | 1-2 hours |
| Phase 7: Testing | 2-3 hours |
| Phase 8: Docker & Deployment | 2-3 hours |
| Phase 9: Cleanup & Polish | 2-3 hours |
| **Total** | **~20-30 hours** |

---

## ğŸ”„ Rollback Plan

Since you're using git:

```bash
# If anything goes wrong
git checkout main
git branch -D migration/bun-vite-convex

# To preserve work in progress
git stash
# or
git commit -m "WIP: migration checkpoint"
```

---

## ğŸ“ Notes

1. **Convex vs Socket.io**: Convex provides real-time subscriptions out of the box. No need to manage socket connections, reconnection logic, or room cleanup - Convex handles this automatically.

2. **Static vs Dynamic**: The `/api/sounds` and `/api/themes` routes currently scan the filesystem. In Vite, you can either:
   - Generate these manifests at build time
   - Import them statically
   - Use Vite's glob imports: `import.meta.glob('./sounds/**/*.wav')`

3. **Future: Clerk Auth**: When ready to add Clerk, you'll wrap the app in `<ClerkProvider>` and use Convex's built-in Clerk integration for authenticated queries/mutations.

4. **Performance**: The Vite + Bun combo should give you significantly faster:
   - Dev server startup (~300ms vs 3-5s)
   - HMR updates (~50ms vs 500ms)
   - Build times (~5s vs 30s)
   - Package installs (bun is 10-25x faster than npm)

---

*Last updated: January 2026*
*Migration target: v0.2.0*
